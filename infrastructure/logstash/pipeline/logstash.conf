input {
  # Receive logs from Fineract and other services
  tcp {
    port => 5000
    codec => json
  }

  # Beats input for Filebeat
  beats {
    port => 5044
  }
}

filter {
  # Parse Fineract logs
  if [type] == "fineract" {
    grok {
      match => { "message" => "%{TIMESTAMP_ISO8601:timestamp} - %{LOGLEVEL:level} %{NUMBER:pid} --- \[%{DATA:thread}\] %{DATA:logger} : %{GREEDYDATA:log_message}" }
    }
  }

  # Add geolocation for IP addresses (useful for fraud detection)
  if [client_ip] {
    geoip {
      source => "client_ip"
      target => "geoip"
    }
  }

  # Tag financial transactions for audit
  if [transaction_type] {
    mutate {
      add_tag => ["audit", "financial_transaction"]
    }
  }

  # BSA/AML: Tag large transactions for CTR reporting
  if [amount] and [amount] >= 10000 {
    mutate {
      add_tag => ["ctr_candidate", "large_transaction"]
    }
  }

  # Mask sensitive data (PII protection - GLBA compliance)
  if [ssn] {
    mutate {
      gsub => ["ssn", "\d{3}-\d{2}-\d{4}", "XXX-XX-XXXX"]
    }
  }

  if [account_number] {
    mutate {
      gsub => ["account_number", "\d{8,}", "****XXXX"]
    }
  }

  # Mask credit card numbers (PCI-DSS compliance)
  if [card_number] {
    mutate {
      gsub => ["card_number", "\d{12}(\d{4})", "************\\1"]
    }
  }
}

output {
  # SECURITY: Elasticsearch with authentication
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    user => "elastic"
    password => "${ELASTICSEARCH_PASSWORD}"
    index => "mifos-audit-%{+YYYY.MM.dd}"
    ssl => false
  }

  # Separate index for compliance/audit logs
  if "audit" in [tags] or "financial_transaction" in [tags] {
    elasticsearch {
      hosts => ["http://elasticsearch:9200"]
      user => "elastic"
      password => "${ELASTICSEARCH_PASSWORD}"
      index => "mifos-compliance-%{+YYYY.MM.dd}"
      ssl => false
    }
  }

  # CTR candidates go to a separate index for review
  if "ctr_candidate" in [tags] {
    elasticsearch {
      hosts => ["http://elasticsearch:9200"]
      user => "elastic"
      password => "${ELASTICSEARCH_PASSWORD}"
      index => "mifos-ctr-review-%{+YYYY.MM.dd}"
      ssl => false
    }
  }

  # Debug output (disable in production)
  # stdout {
  #   codec => rubydebug
  # }
}