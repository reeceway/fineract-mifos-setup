input {
  # Receive logs from Fineract and other services
  tcp {
    port => 5000
    codec => json
  }

  # Beats input for Filebeat
  beats {
    port => 5044
  }
}

filter {
  # Parse Fineract logs
  if [type] == "fineract" {
    grok {
      match => { "message" => "%{TIMESTAMP_ISO8601:timestamp} - %{LOGLEVEL:level} %{NUMBER:pid} --- \[%{DATA:thread}\] %{DATA:logger} : %{GREEDYDATA:log_message}" }
    }
  }

  # Add geolocation for IP addresses (useful for fraud detection)
  if [client_ip] {
    geoip {
      source => "client_ip"
      target => "geoip"
    }
  }

  # Tag financial transactions for audit
  if [transaction_type] {
    mutate {
      add_tag => ["audit", "financial_transaction"]
    }
  }

  # Mask sensitive data (PII protection)
  if [ssn] {
    mutate {
      gsub => ["ssn", "\d{3}-\d{2}-\d{4}", "XXX-XX-XXXX"]
    }
  }

  if [account_number] {
    mutate {
      gsub => ["account_number", "\d{8,}", "****XXXX"]
    }
  }
}

output {
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    index => "mifos-audit-%{+YYYY.MM.dd}"
  }

  # Also output to stdout for debugging
  stdout {
    codec => rubydebug
  }
}