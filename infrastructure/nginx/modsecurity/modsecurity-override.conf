# ModSecurity Custom Rules for MifosBank
# This file adds banking-specific rules after the CRS rules
# File: RESPONSE-999-EXCLUSION-RULES-AFTER-CRS.conf

# Banking-specific: Log suspicious account enumeration attempts
SecRule REQUEST_URI "@rx \/accounts?\/[0-9]{10,}" \
    "id:100010,\
    phase:1,\
    log,\
    pass,\
    msg:'Potential account enumeration attempt',\
    tag:'banking',\
    severity:'WARNING'"

# Banking-specific: Log large transaction amounts (BSA CTR threshold)
SecRule ARGS:amount "@gt 10000" \
    "id:100011,\
    phase:2,\
    log,\
    pass,\
    msg:'Large transaction amount detected (CTR threshold)',\
    tag:'banking',\
    tag:'bsa-ctr',\
    severity:'INFO'"

# Banking-specific: Log wire transfer requests
SecRule REQUEST_URI "@contains /wire" \
    "id:100012,\
    phase:1,\
    log,\
    pass,\
    msg:'Wire transfer request',\
    tag:'banking',\
    tag:'wire-transfer',\
    severity:'INFO'"

# Whitelist internal health check endpoints
SecRule REQUEST_URI "^/healthz$" \
    "id:100100,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleEngine=Off"

# Whitelist Keycloak token endpoint (high volume, frequently triggers false positives)
SecRule REQUEST_URI "^/auth/realms/.*/protocol/openid-connect/token$" \
    "id:100101,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=920170"

# Whitelist Fineract API authentication
SecRule REQUEST_URI "^/fineract-provider/api/v1/authentication$" \
    "id:100102,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=920170"
