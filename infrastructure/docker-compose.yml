# =============================================================================
# COMPLETE INSTITUTIONAL BANKING INFRASTRUCTURE - PRODUCTION SECURED
# =============================================================================
# All credentials use environment variables from .env file
# All services use internal networking (no exposed database ports)
# SSL/TLS enabled where supported
# =============================================================================

services:

  # ===========================================================================
  # MESSAGE GATEWAY - SMS/Email Notifications (Official Mifos Component)
  # ===========================================================================
  message-gateway:
    image: openmf/message-gateway:latest
    container_name: mifos-message-gateway
    restart: always
    ports:
      - "9191:9191"
    environment:
      - SPRING_DATASOURCE_URL=jdbc:mysql://infra-mysql:3306/messagegateway
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=${MYSQL_PASSWORD}
      - PROVIDER_TWILIO_AUTHTOKEN=${TWILIO_AUTH_TOKEN:-}
      - PROVIDER_TWILIO_ACCOUNTSID=${TWILIO_ACCOUNT_SID:-}
      - PROVIDER_TWILIO_PHONENO=${TWILIO_PHONE_NUMBER:-}
      - SPRING_MAIL_HOST=${SMTP_HOST:-smtp.gmail.com}
      - SPRING_MAIL_PORT=${SMTP_PORT:-587}
      - SPRING_MAIL_USERNAME=${SMTP_USERNAME:-}
      - SPRING_MAIL_PASSWORD=${SMTP_PASSWORD:-}
    # Hardening
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp
    depends_on:
      infra-mysql:
        condition: service_healthy
    networks:
      - app-network
      - data-network
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M

  # ===========================================================================
  # KEYCLOAK - Enterprise Identity & Access Management
  # ===========================================================================
  keycloak:
    image: quay.io/keycloak/keycloak:23.0
    container_name: mifos-keycloak
    restart: always
    # PRODUCTION MODE with realm import
    command: >
      start
      --import-realm
      --hostname=localhost
      --hostname-strict=false
      --http-enabled=true
      --proxy=edge
    # SECURITY: Route through nginx, no direct exposure
    expose:
      - "8080"
    environment:
      - KEYCLOAK_ADMIN=${KEYCLOAK_ADMIN:-admin}
      - KEYCLOAK_ADMIN_PASSWORD=${KEYCLOAK_ADMIN_PASSWORD}
      - KC_DB=postgres
      - KC_DB_URL=jdbc:postgresql://keycloak-postgres:5432/keycloak
      - KC_DB_USERNAME=keycloak
      - KC_DB_PASSWORD=${POSTGRES_PASSWORD}
      # Logging for audit
      - KC_LOG_LEVEL=INFO
      - KC_LOG_CONSOLE_OUTPUT=json
    volumes:
      # Import realm with MFA enabled
      - ./keycloak/mifos-realm.json:/opt/keycloak/data/import/mifos-realm.json:ro
    # Hardening
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp
      - /opt/keycloak/data/tmp
    depends_on:
      keycloak-postgres:
        condition: service_healthy
    networks:
      - app-network
      - data-network
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G

  keycloak-postgres:
    image: postgres:15-alpine
    container_name: keycloak-postgres
    restart: always
    environment:
      - POSTGRES_DB=keycloak
      - POSTGRES_USER=keycloak
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    # Hardening
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
      - DAC_OVERRIDE
      - DAC_READ_SEARCH
    security_opt:
      - no-new-privileges:true
    tmpfs:
      - /tmp
      - /var/run/postgresql
    volumes:
      - keycloak-postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U keycloak"]
      interval: 10s
      timeout: 5s
      retries: 5
    # SECURITY: No external port exposure
    expose:
      - "5432"
    networks:
      - data-network
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M

  # ===========================================================================
  # MINIO - S3-Compatible Document Storage
  # ===========================================================================
  minio:
    image: minio/minio:RELEASE.2024-01-16T16-07-38Z
    container_name: mifos-minio
    restart: always
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:-minio_admin}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
    # Hardening
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp
      - /minio/config
    volumes:
      - minio-data:/data
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 30s
      timeout: 20s
      retries: 5
      start_period: 30s
    networks:
      - app-network
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G

  minio-setup:
    image: minio/mc:RELEASE.2024-01-16T16-06-34Z
    container_name: minio-setup
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set myminio http://minio:9000 $${MINIO_ROOT_USER} $${MINIO_ROOT_PASSWORD};
      mc mb myminio/kyc-documents --ignore-existing;
      mc mb myminio/loan-documents --ignore-existing;
      mc mb myminio/statements --ignore-existing;
      mc mb myminio/reports --ignore-existing;
      mc mb myminio/signatures --ignore-existing;
      exit 0;
      "
    # Hardening
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp
      - /root/.mc
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:-minio_admin}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
    networks:
      - app-network

  # ===========================================================================
  # APACHE KAFKA - Event Streaming Platform
  # ===========================================================================
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: mifos-zookeeper
    restart: always
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    volumes:
      - zookeeper-data:/var/lib/zookeeper/data
      - zookeeper-logs:/var/lib/zookeeper/log
    # SECURITY: No external port exposure
    expose:
      - "2181"
    networks:
      - data-network
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: mifos-kafka
    restart: always
    # SECURITY: SSL for external, PLAINTEXT for inter-broker
    expose:
      - "9092"
      - "9093"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      # Dual listeners: PLAINTEXT for inter-broker, SSL for clients
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092,SSL://0.0.0.0:9093
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,SSL://kafka:9093
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,SSL:SSL
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      # SSL Keystore configuration (JKS format)
      KAFKA_SSL_KEYSTORE_FILENAME: kafka.broker.keystore.jks
      KAFKA_SSL_KEYSTORE_PASSWORD: changeit
      KAFKA_SSL_KEY_PASSWORD: changeit
      # SSL Truststore configuration (JKS format)
      KAFKA_SSL_TRUSTSTORE_FILENAME: kafka.broker.truststore.jks
      KAFKA_SSL_TRUSTSTORE_PASSWORD: changeit
      # SSL settings for client connections
      KAFKA_SSL_CLIENT_AUTH: none
      KAFKA_SSL_ENDPOINT_IDENTIFICATION_ALGORITHM: ""
      # Kafka settings
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
    # Hardening
    # Reverted hardening for Kafka/Zookeeper due to image compatibility issues (requires root/special caps)
    volumes:
      - kafka-data:/var/lib/kafka/data
      - ../ssl/kafka:/etc/kafka/secrets:ro
    depends_on:
      - zookeeper
    networks:
      - data-network
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G

  kafka-ui:
    image: provectuslabs/kafka-ui:v0.7.1
    container_name: mifos-kafka-ui
    restart: always
    ports:
      - "8090:8080"
    environment:
      - KAFKA_CLUSTERS_0_NAME=mifos-cluster
      - KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS=kafka:9093
      - KAFKA_CLUSTERS_0_ZOOKEEPER=zookeeper:2181
      - KAFKA_CLUSTERS_0_PROPERTIES_SECURITY_PROTOCOL=SSL
      - KAFKA_CLUSTERS_0_PROPERTIES_SSL_TRUSTSTORE_LOCATION=/etc/kafka/secrets/kafka.broker.truststore.jks
      - KAFKA_CLUSTERS_0_PROPERTIES_SSL_TRUSTSTORE_PASSWORD=changeit
      - KAFKA_CLUSTERS_0_PROPERTIES_SSL_TRUSTSTORE_TYPE=JKS
    # Hardening
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp
    volumes:
      - ../ssl/kafka:/etc/kafka/secrets:ro
    depends_on:
      - kafka
    networks:
      - app-network
      - data-network
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

  # ===========================================================================
  # ELASTICSEARCH - Search & Audit Logging (SECURITY ENABLED)
  # ===========================================================================
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    container_name: mifos-elasticsearch
    restart: always
    # SECURITY: No external port exposure
    expose:
      - "9200"
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=true
      - xpack.security.enrollment.enabled=false
      - ELASTIC_PASSWORD=${ELASTICSEARCH_PASSWORD}
      - "ES_JAVA_OPTS=-Xms1g -Xmx1g"
      - cluster.name=mifos-audit
    # Hardening
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    tmpfs:
      - /tmp
    volumes:
      - elasticsearch-data:/usr/share/elasticsearch/data
    healthcheck:
      test: ["CMD-SHELL", "curl -s -u elastic:${ELASTICSEARCH_PASSWORD} http://localhost:9200/_cluster/health | grep -q '\"status\":\"green\"\\|\"status\":\"yellow\"'"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - data-network
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G

  # ===========================================================================
  # KIBANA - Visualization & Audit Dashboard
  # ===========================================================================
  kibana:
    image: docker.elastic.co/kibana/kibana:8.11.0
    container_name: mifos-kibana
    restart: always
    ports:
      - "5601:5601"
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
      - ELASTICSEARCH_USERNAME=kibana_system
      - ELASTICSEARCH_PASSWORD=${ELASTICSEARCH_PASSWORD}
    # Hardening
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    tmpfs:
      - /tmp
    depends_on:
      elasticsearch:
        condition: service_healthy
    networks:
      - app-network
      - data-network
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G

  # ===========================================================================
  # LOGSTASH - Log Processing Pipeline
  # ===========================================================================
  logstash:
    image: docker.elastic.co/logstash/logstash:8.11.0
    container_name: mifos-logstash
    restart: always
    ports:
      - "5044:5044"
      - "5001:5000"
    volumes:
      - ./logstash/pipeline:/usr/share/logstash/pipeline:ro
    environment:
      - "LS_JAVA_OPTS=-Xmx512m -Xms512m"
      - ELASTICSEARCH_PASSWORD=${ELASTICSEARCH_PASSWORD}
    # Hardening
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    tmpfs:
      - /tmp
    depends_on:
      elasticsearch:
        condition: service_healthy
    networks:
      - data-network
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G

  # ===========================================================================
  # HASHICORP VAULT - Secrets Management (PRODUCTION MODE)
  # ===========================================================================
  vault:
    image: hashicorp/vault:1.15
    container_name: mifos-vault
    restart: always
    ports:
      - "8210:8200"
    cap_add:
      - IPC_LOCK
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    read_only: true
    volumes:
      - ./vault/file:/vault/file
      - ./vault/config:/vault/config:ro
      - ./vault/ssl:/vault/ssl:ro
    entrypoint: vault server -config=/vault/config/vault.hcl
    networks:
      - app-network
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

  # ===========================================================================
  # REDIS - Caching & Session Management (TLS + AUTH ENABLED)
  # ===========================================================================
  redis:
    image: redis:7-alpine
    container_name: mifos-redis
    restart: always
    # SECURITY: No external port exposure
    expose:
      - "6379"
    command: >
      redis-server
      --appendonly yes
      --requirepass ${REDIS_PASSWORD}
      --tls-port 6379
      --port 0
      --tls-cert-file /tls/redis.crt
      --tls-key-file /tls/redis.key
      --tls-ca-cert-file /tls/ca.crt
      --tls-auth-clients no
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
      - DAC_OVERRIDE
      - DAC_READ_SEARCH
    security_opt:
      - no-new-privileges:true
    read_only: true
    volumes:
      - redis-data:/data
      - ../ssl/redis:/tls:ro
    healthcheck:
      test: ["CMD", "redis-cli", "--tls", "--cacert", "/tls/ca.crt", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - data-network
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M

  # ===========================================================================
  # MYSQL - Message Gateway & Additional Services Database (SSL ENABLED)
  # ===========================================================================
  infra-mysql:
    image: mysql:8.0.36
    container_name: infra-mysql
    restart: always
    # SECURITY: No external port exposure
    expose:
      - "3306"
    command: >
      --ssl-ca=/etc/mysql/ssl/ca.crt
      --ssl-cert=/etc/mysql/ssl/mysql.crt
      --ssl-key=/etc/mysql/ssl/mysql.key
      --require_secure_transport=ON
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_PASSWORD}
      - MYSQL_DATABASE=messagegateway
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
      - DAC_OVERRIDE
      - DAC_READ_SEARCH
    # MySQL requires some capabilities to run efficiently, typically SETGID, SETUID, SYS_NICE etc if running as root initially to drop privs
    # Running strictly confined MySQL can be tricky. official image starts as root then switches.
    # We will try dropping ALL and see if it holds, otherwise we might need minimal caps.
    # Using 'no-new-privileges:true' prevents escalation.
    security_opt:
      - no-new-privileges:true
    # MySQL needs write to /tmp
    tmpfs:
      - /tmp
    volumes:
      - infra-mysql-data:/var/lib/mysql
      - ../ssl/mysql:/etc/mysql/ssl:ro
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "--ssl-mode=REQUIRED"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - data-network
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G

  # ===========================================================================
  # NGINX - API Gateway with WAF-like Security Controls
  # ===========================================================================
  # Features: Rate limiting, Security headers, HTTPS, Connection limits
  # For full ModSecurity WAF, deploy separately with OWASP CRS image
  nginx:
    image: nginx:1.25-alpine
    container_name: mifos-nginx
    restart: always
    ports:
      - "443:443"
      - "9443:8443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - nginx-logs:/var/log/nginx
    depends_on:
      - keycloak
      - minio
    networks:
      - dmz-network
      - app-network
      - fineract-network
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 256M
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ===========================================================================
  # PROMETHEUS - Metrics Collection
  # ===========================================================================
  prometheus:
    image: prom/prometheus:v2.48.0
    container_name: mifos-prometheus
    restart: always
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./prometheus/alert-rules.yml:/etc/prometheus/alert-rules.yml:ro
      - prometheus-data:/prometheus
    # Hardening
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=90d'
    networks:
      - monitoring-network
      - app-network
      - data-network
      - fineract-network
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M

  # ===========================================================================
  # GRAFANA - Monitoring Dashboards
  # ===========================================================================
  grafana:
    image: grafana/grafana:10.2.3
    container_name: mifos-grafana
    restart: always
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=${GF_SECURITY_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GF_SECURITY_ADMIN_PASSWORD}
      - GF_USERS_ALLOW_SIGN_UP=false
    # Hardening
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp
      - /var/lib/grafana/plugins
      - /var/lib/grafana/png
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana/provisioning/datasources:/etc/grafana/provisioning/datasources:ro
      - ./grafana/provisioning/alerting:/etc/grafana/provisioning/alerting:ro
      - ./grafana/provisioning/dashboards:/etc/grafana/provisioning/dashboards:ro
    depends_on:
      - prometheus
    networks:
      - monitoring-network
      - app-network
      - fineract-network
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M

  # ===========================================================================
  # FILEBEAT - Log Shipper
  # ===========================================================================
  filebeat:
    image: docker.elastic.co/beats/filebeat:8.11.0
    container_name: mifos-filebeat
    user: root
    volumes:
      - ./filebeat/filebeat.yml:/usr/share/filebeat/filebeat.yml:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    depends_on:
      - logstash
      - elasticsearch
    networks:
      - monitoring-network
      - app-network

  # ===========================================================================
  # CADVISOR - Container Metrics
  # ===========================================================================
  cadvisor:
    image: gcr.io/cadvisor/cadvisor:v0.47.2
    container_name: mifos-cadvisor
    privileged: true
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /dev/disk/:/dev/disk:ro
    ports:
      - "8081:8080"
    networks:
      - monitoring-network
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M

# =============================================================================
# VOLUMES
# =============================================================================
volumes:
  keycloak-postgres-data:
  minio-data:
  zookeeper-data:
  zookeeper-logs:
  kafka-data:
  elasticsearch-data:
  vault-data:
  redis-data:
  infra-mysql-data:
  prometheus-data:
  grafana-data:
  nginx-logs:

# =============================================================================
# NETWORKS - Segmented for Security
# =============================================================================
networks:
  dmz-network:
    name: mifos-dmz
    driver: bridge
  app-network:
    external: true
    name: mifos-app
  data-network:
    name: mifos-data
    driver: bridge
  monitoring-network:
    name: mifos-monitoring
    driver: bridge
  fineract-network:
    external: true
    name: mifos-fineract-network