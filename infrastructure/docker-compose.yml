version: '3.8'

# =============================================================================
# COMPLETE INSTITUTIONAL BANKING INFRASTRUCTURE - PRODUCTION SECURED
# =============================================================================
# All credentials use environment variables from .env file
# All services use internal networking (no exposed database ports)
# SSL/TLS enabled where supported
# =============================================================================

services:

  # ===========================================================================
  # MESSAGE GATEWAY - SMS/Email Notifications (Official Mifos Component)
  # ===========================================================================
  message-gateway:
    image: openmf/message-gateway:latest
    container_name: mifos-message-gateway
    restart: always
    ports:
      - "9191:9191"
    environment:
      - SPRING_DATASOURCE_URL=jdbc:mysql://infra-mysql:3306/messagegateway
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=${MYSQL_PASSWORD}
      - PROVIDER_TWILIO_AUTHTOKEN=${TWILIO_AUTH_TOKEN:-}
      - PROVIDER_TWILIO_ACCOUNTSID=${TWILIO_ACCOUNT_SID:-}
      - PROVIDER_TWILIO_PHONENO=${TWILIO_PHONE_NUMBER:-}
      - SPRING_MAIL_HOST=${SMTP_HOST:-smtp.gmail.com}
      - SPRING_MAIL_PORT=${SMTP_PORT:-587}
      - SPRING_MAIL_USERNAME=${SMTP_USERNAME:-}
      - SPRING_MAIL_PASSWORD=${SMTP_PASSWORD:-}
    depends_on:
      infra-mysql:
        condition: service_healthy
    networks:
      - app-network
      - data-network
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M

  # ===========================================================================
  # KEYCLOAK - Enterprise Identity & Access Management
  # ===========================================================================
  keycloak:
    image: quay.io/keycloak/keycloak:23.0
    container_name: mifos-keycloak
    restart: always
    command: start-dev
    ports:
      - "8180:8080"
    environment:
      - KEYCLOAK_ADMIN=${KEYCLOAK_ADMIN:-admin}
      - KEYCLOAK_ADMIN_PASSWORD=${KEYCLOAK_ADMIN_PASSWORD}
      - KC_DB=postgres
      - KC_DB_URL=jdbc:postgresql://keycloak-postgres:5432/keycloak
      - KC_DB_USERNAME=keycloak
      - KC_DB_PASSWORD=${POSTGRES_PASSWORD}
    depends_on:
      keycloak-postgres:
        condition: service_healthy
    networks:
      - app-network
      - data-network
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G

  keycloak-postgres:
    image: postgres:15-alpine
    container_name: keycloak-postgres
    restart: always
    environment:
      - POSTGRES_DB=keycloak
      - POSTGRES_USER=keycloak
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    volumes:
      - keycloak-postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U keycloak"]
      interval: 10s
      timeout: 5s
      retries: 5
    # SECURITY: No external port exposure
    expose:
      - "5432"
    networks:
      - data-network
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M

  # ===========================================================================
  # MINIO - S3-Compatible Document Storage
  # ===========================================================================
  minio:
    image: minio/minio:RELEASE.2024-01-16T16-07-38Z
    container_name: mifos-minio
    restart: always
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:-minio_admin}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
    volumes:
      - minio-data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
    networks:
      - app-network
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G

  minio-setup:
    image: minio/mc:RELEASE.2024-01-16T16-06-34Z
    container_name: minio-setup
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set myminio http://minio:9000 $${MINIO_ROOT_USER} $${MINIO_ROOT_PASSWORD};
      mc mb myminio/kyc-documents --ignore-existing;
      mc mb myminio/loan-documents --ignore-existing;
      mc mb myminio/statements --ignore-existing;
      mc mb myminio/reports --ignore-existing;
      mc mb myminio/signatures --ignore-existing;
      exit 0;
      "
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:-minio_admin}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
    networks:
      - app-network

  # ===========================================================================
  # APACHE KAFKA - Event Streaming Platform
  # ===========================================================================
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: mifos-zookeeper
    restart: always
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    volumes:
      - zookeeper-data:/var/lib/zookeeper/data
      - zookeeper-logs:/var/lib/zookeeper/log
    # SECURITY: No external port exposure
    expose:
      - "2181"
    networks:
      - data-network
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: mifos-kafka
    restart: always
    # SECURITY: Only expose for internal service communication
    expose:
      - "9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
    volumes:
      - kafka-data:/var/lib/kafka/data
    depends_on:
      - zookeeper
    networks:
      - data-network
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G

  kafka-ui:
    image: provectuslabs/kafka-ui:v0.7.1
    container_name: mifos-kafka-ui
    restart: always
    ports:
      - "8090:8080"
    environment:
      - KAFKA_CLUSTERS_0_NAME=mifos-cluster
      - KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS=kafka:9092
      - KAFKA_CLUSTERS_0_ZOOKEEPER=zookeeper:2181
    depends_on:
      - kafka
    networks:
      - app-network
      - data-network
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

  # ===========================================================================
  # ELASTICSEARCH - Search & Audit Logging (SECURITY ENABLED)
  # ===========================================================================
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    container_name: mifos-elasticsearch
    restart: always
    # SECURITY: No external port exposure
    expose:
      - "9200"
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=true
      - xpack.security.enrollment.enabled=false
      - ELASTIC_PASSWORD=${ELASTICSEARCH_PASSWORD}
      - "ES_JAVA_OPTS=-Xms1g -Xmx1g"
      - cluster.name=mifos-audit
    volumes:
      - elasticsearch-data:/usr/share/elasticsearch/data
    healthcheck:
      test: ["CMD-SHELL", "curl -s -u elastic:${ELASTICSEARCH_PASSWORD} http://localhost:9200/_cluster/health | grep -q '\"status\":\"green\"\\|\"status\":\"yellow\"'"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - data-network
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G

  # ===========================================================================
  # KIBANA - Visualization & Audit Dashboard
  # ===========================================================================
  kibana:
    image: docker.elastic.co/kibana/kibana:8.11.0
    container_name: mifos-kibana
    restart: always
    ports:
      - "5601:5601"
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
      - ELASTICSEARCH_USERNAME=kibana_system
      - ELASTICSEARCH_PASSWORD=${ELASTICSEARCH_PASSWORD}
    depends_on:
      elasticsearch:
        condition: service_healthy
    networks:
      - app-network
      - data-network
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G

  # ===========================================================================
  # LOGSTASH - Log Processing Pipeline
  # ===========================================================================
  logstash:
    image: docker.elastic.co/logstash/logstash:8.11.0
    container_name: mifos-logstash
    restart: always
    ports:
      - "5044:5044"
      - "5000:5000"
    volumes:
      - ./logstash/pipeline:/usr/share/logstash/pipeline:ro
    environment:
      - "LS_JAVA_OPTS=-Xmx512m -Xms512m"
      - ELASTICSEARCH_PASSWORD=${ELASTICSEARCH_PASSWORD}
    depends_on:
      elasticsearch:
        condition: service_healthy
    networks:
      - data-network
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G

  # ===========================================================================
  # HASHICORP VAULT - Secrets Management (PRODUCTION MODE)
  # ===========================================================================
  vault:
    image: hashicorp/vault:1.15
    container_name: mifos-vault
    restart: always
    ports:
      - "8200:8200"
    environment:
      - VAULT_DEV_ROOT_TOKEN_ID=${VAULT_DEV_ROOT_TOKEN_ID}
      - VAULT_DEV_LISTEN_ADDRESS=0.0.0.0:8200
    cap_add:
      - IPC_LOCK
    volumes:
      - vault-data:/vault/data
    networks:
      - app-network
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M

  # ===========================================================================
  # REDIS - Caching & Session Management (AUTH ENABLED)
  # ===========================================================================
  redis:
    image: redis:7-alpine
    container_name: mifos-redis
    restart: always
    # SECURITY: No external port exposure
    expose:
      - "6379"
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - data-network
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M

  # ===========================================================================
  # MYSQL - Message Gateway & Additional Services Database
  # ===========================================================================
  infra-mysql:
    image: mysql:8.0.36
    container_name: infra-mysql
    restart: always
    # SECURITY: No external port exposure
    expose:
      - "3306"
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_PASSWORD}
      - MYSQL_DATABASE=messagegateway
    volumes:
      - infra-mysql-data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - data-network
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G

  # ===========================================================================
  # NGINX - API Gateway & Load Balancer (SSL ENABLED)
  # ===========================================================================
  nginx:
    image: nginx:1.25-alpine
    container_name: mifos-nginx
    restart: always
    ports:
      - "443:443"
      - "8443:8443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - keycloak
      - minio
    networks:
      - dmz-network
      - app-network
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 256M

  # ===========================================================================
  # PROMETHEUS - Metrics Collection
  # ===========================================================================
  prometheus:
    image: prom/prometheus:v2.48.0
    container_name: mifos-prometheus
    restart: always
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=90d'
    networks:
      - monitoring-network
      - app-network
      - data-network
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M

  # ===========================================================================
  # GRAFANA - Monitoring Dashboards
  # ===========================================================================
  grafana:
    image: grafana/grafana:10.2.3
    container_name: mifos-grafana
    restart: always
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=${GF_SECURITY_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GF_SECURITY_ADMIN_PASSWORD}
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - grafana-data:/var/lib/grafana
    depends_on:
      - prometheus
    networks:
      - monitoring-network
      - app-network
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M

# =============================================================================
# VOLUMES
# =============================================================================
volumes:
  keycloak-postgres-data:
  minio-data:
  zookeeper-data:
  zookeeper-logs:
  kafka-data:
  elasticsearch-data:
  vault-data:
  redis-data:
  infra-mysql-data:
  prometheus-data:
  grafana-data:

# =============================================================================
# NETWORKS - Segmented for Security
# =============================================================================
networks:
  dmz-network:
    name: mifos-dmz
    driver: bridge
  app-network:
    name: mifos-app
    driver: bridge
  data-network:
    name: mifos-data
    driver: bridge
  monitoring-network:
    name: mifos-monitoring
    driver: bridge